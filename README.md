# cannabis.ca.gov
development for cannabis site

more details on <a href="https://github.com/cagov/cannabis.ca.gov/wiki">wiki</a>

## Todo

This repo is under active development as we create a headless version of the cannabis WordPress site.

### Code organization goals

- All the components currently in src/components should be refined, promoted to the cagov/design-system repo, then those folders should be deleted from this repository and the npm packages should be installed to provide the features.
- The build system dependencies should also be externalized so 11ty and all its dependencies can be accessed via npx locally and in github action steps for builds in our pipelines

Files which will remain in this repo:

- /wordpress content is written here by our publishing service from the WordPress API. This will continue to happen. These files will not be manually modified in this repo.
- /templates contains the headless versions of page templates, that code will continue to be managed manually in this repo. The data in the templates should be generated by the WordPress API data: the contents of the menus is already pulled from the API for example.

#### Some files used only in WordPress:

This repo contains files used by the WordPress site like:

- src/css/colorscheme-cannabisv1.0.7.min.css
- manual-cawebv1.0.1.css


The whole src/js/wordpress directory for the bundle of components used in WordPress authoring and public site

The following command is used to generate the bundle files used by the production WordPress monolith sites;

```
npm run wordpress-bundle
```

This generates a hashed filename in the src/js/wordpress/generated directory.


The npm script in this package.json references multiple commands which point to specific rollup config files which reference the modules included.

When content in this repository is modified it gets deployed to headles.cannabis.ca.gov so the new hashed filename can be referenced in the WordPress monolith custom JS textarea we modify in the theme config in the wordpress admin. Since we are using hashed filenames we can revert easily to the prior filename.

## Testing

We are evaluating the two tools below:

### Integration(End to end) tests with playwright

The playwright headless tests are triggered with ```npm test```. These run in the git action e2e.yml. The git action runs setup scripts and starts a web dev server to return files in docs/ after the build runs.

To run playwright tests locally
- ```npm test:playwright``` to run the playwright tests headlessly
or
- ```npm test:playwright:headed``` to run the playwright tests headed so you can see what it is doing. More debugging tips and tools on playwright on the <a href="https://playwright.dev/docs/debug">playwright debugging page</a>

More info on playwright at <a href="https://playwright.dev/">playwright.dev</a>

When writing new playwright tests or to get used to the tool initially try out the codegen tool passing the target url as the final argument:

```
npx playwright codegen https://cannabis.ca.gov
```

Benefits:
- Works nicely in a git action
- Runs reliably
- Helpful debugging tools
- Successfully integrated full page accessibility checks with headless axe package
- The codegen tool is helpful
- Supports 3 browser engines so we can test Chrome, Firefox and Safari

### Integration(End to end) tests with cypress


The cypress headless tests are triggered with ```npm test```. These run in the git action e2e-cypress.yml. The git action runs setup scripts and starts a web dev server to return files in docs/ after the build runs.

To run cypress tests locally
- ```npm test:cypress``` to start a dev server and launch the cypress test runner tool

More info on <a href="https://www.cypress.io/">cypress</a>

Benefits:
- Works nicely in a git action
- Runs reliably
- Helpful debugging tools
- Supports 2 browser engines so we can test Chrome and Firefox
